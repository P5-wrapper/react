const w=(function(){let o,e=[];for(let i=0;i<256;i++){o=i;for(let t=0;t<8;t++)o=1&o?3988292384^o>>>1:o>>>1;e[i]=o}return e})(),g=new TextEncoder;class p{#t=[];#e=[];#s=0;constructor(){}static generateCentralDirectoryHeader(e,i){const t=new ArrayBuffer(46+e.filename.length),r=new Uint8Array(t),s=new DataView(t);s.setUint32(0,1347092738),s.setUint16(4,20,!0),s.setUint16(6,20,!0),s.setUint16(12,e.modifyTime,!0),s.setUint16(14,e.modifyDate,!0),s.setUint32(16,e.checksum,!0),s.setUint32(20,e.compressedSize,!0),s.setUint32(24,e.uncompressedSize,!0),s.setUint16(28,e.filename.length,!0),s.setUint32(42,i,!0);const n=g.encode(e.filename);return r.set(n,46),s.buffer}addFile(e){const i=p.generateCentralDirectoryHeader(e,this.#s);this.#t.push(e),this.#e.push(i),this.#s+=e.localFileHeader.byteLength,this.#s+=e.content.length}pack(){const e=this.#e.reduce((s,n)=>s+=n.byteLength,0);this.#s+=e;const i=new ArrayBuffer(22),t=new DataView(i);t.setUint32(0,1347093766),t.setUint16(8,this.#t.length,!0),t.setUint16(10,this.#t.length,!0),t.setUint32(12,e,!0),t.setUint32(16,this.#s-e,!0);const r=[];for(const s of this.#t)r.push(s.localFileHeader),r.push(s.content);return r.push(...this.#e),r.push(t.buffer),new Blob(r)}}class U{modifyTime;modifyDate;checksum;compressedSize;uncompressedSize;filename;content;constructor(e,i){this.filename=e,this.content=i;const{date:t,time:r}=(function(){const s=new Date;let n=s.getUTCHours();n<<=6,n|=s.getUTCMinutes(),n<<=5,n|=s.getUTCSeconds()/2;let a=s.getUTCFullYear()-1980;return a<<=4,a|=s.getUTCMonth()+1,a<<=5,a|=s.getUTCDate(),{date:a,time:n}})();this.modifyTime=r,this.modifyDate=t,this.checksum=(function(s,n,a,c){const h=w,m=c+a;s^=-1;for(let u=c;u<m;u++)s=s>>>8^h[255&(s^n[u])];return-1^s})(0,i,i.length,0),this.compressedSize=i.length,this.uncompressedSize=i.length}get localFileHeader(){const e=new ArrayBuffer(30+this.filename.length),i=new Uint8Array(e),t=new DataView(e);t.setUint32(0,1347093252),t.setUint16(4,20,!0),t.setUint16(10,this.modifyTime,!0),t.setUint16(12,this.modifyDate,!0),t.setUint32(14,this.checksum,!0),t.setUint32(18,this.compressedSize,!0),t.setUint32(22,this.uncompressedSize,!0),t.setUint16(26,this.filename.length,!0);const r=g.encode(this.filename);return i.set(r,30),t.buffer}}const f={"image/png":"png","image/jpeg":"jpg","image/webp":"webp"};class d extends EventTarget{#t=0;#e;#s=[];#i;#n;#o;#c;#r=0;#a;state="inactive";constructor(e,i,t=60){super(),this.#e=e,this.#n=1e3/t,this.#a=i}start(){this.state="recording",this.dispatchEvent(new CustomEvent("start")),this.frame()}stop(){this.state="inactive",this.#i&&cancelAnimationFrame(this.#i);const e=Promise.all(this.#s.map(t=>t.arrayBuffer())),i=new p;e.then(t=>{for(let r=0;r<t.length;r++){const s=new U(`capture-${String(r+1).padStart(5,"0")}.${f[this.#a]}`,new Uint8Array(t[r]));i.addFile(s)}this.dispatchEvent(new CustomEvent("stop",{detail:{blob:i.pack()}}))})}pause(){this.state="paused",this.#i&&cancelAnimationFrame(this.#i),this.dispatchEvent(new CustomEvent("pause"))}resume(){this.state="recording",this.dispatchEvent(new CustomEvent("resume")),this.frame()}frame(e){if(this.state==="recording"){if(this.#o=e-this.#c,this.#c=e,this.#r+=this.#o||0,this.#r>=this.#n||this.#n===Number.POSITIVE_INFINITY){this.#r=0;let i=this.#t;this.#e.toBlob(t=>{this.#s[i]=t},this.#a),this.#t++}this.#n<Number.POSITIVE_INFINITY&&(this.#i=requestAnimationFrame(this.frame.bind(this)))}}}class l{#t;#e;constructor(e){const i=e.frameRate==="manual"?0:e.frameRate,t=[],r=e.source instanceof HTMLCanvasElement?e.source:e.source.canvas,s=r.captureStream(i);let n;n=Object.keys(f).includes(e.mimeType)?new d(r,e.mimeType,i):new MediaRecorder(s,{mimeType:e.mimeType??"video/webm;codecs=vp8"}),n.addEventListener("start",a=>{console.log("recording started")}),n.addEventListener("stop",a=>{let c,h;if(this.#e instanceof d?(c=a.detail.blob,h="recording.zip"):(c=new Blob(t),h="recording.webm"),typeof e?.stopCallback!="function"||e?.stopCallback(c)){const m=URL.createObjectURL(c),u=document.createElement("a");u.href=m,u.download=h,u.click()}}),n.addEventListener("dataavailable",a=>{t.push(a.data)}),n.addEventListener("pause",a=>{console.log("recording paused")}),n.addEventListener("resume",a=>{console.log("recording resumed")}),this.#e=n,this.#t=s}get state(){return this.#e.state}start(){this.#e.start()}stop(){this.#e.stop()}pause(){this.#e.pause()}resume(){this.#e.resume()}frame(){this.#e instanceof d?this.#e.frame():this.#t.getVideoTracks()[0].requestFrame()}}function y(o,e,i){let t,r;const s=o.VERSION.split(".").map(n=>parseInt(n));s[0]>2||s[0]>2&&s[1]>0||s[0]===2&&s[1]===0&&s[2]>=3?(o.Recorder=l,i.postdraw=function(){t&&t.state==="recording"&&r?.frameRate==="manual"&&t.frame()},e.setRecording=function(n){n.frameRate!=="manual"||"CanvasCaptureMediaStreamTrack"in window||Object.keys(f).includes(n.mimeType)?r=n:console.error("Your browser does not support directly specifying frame capture timing with { frameRate: 'manual' }.")},e.startRecording=function(){r=Object.assign({source:this.canvas,frameRate:this.getTargetFrameRate()},r),t=new l(r),t.start()},e.stopRecording=function(){t.stop()},e.pauseRecording=function(){t.pause()},e.resumeRecording=function(){t.resume()},e.createRecording=function(n){return new l(n)}):console.error("p5.record.js requires p5.js >= 2.0.3")}typeof p5<"u"&&p5.registerAddon(y);export{l as Recorder,y as p5Record};

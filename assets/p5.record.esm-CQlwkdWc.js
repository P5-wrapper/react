function g(){let t,e=[];for(let s=0;s<256;s++){t=s;for(let i=0;i<8;i++)t=t&1?3988292384^t>>>1:t>>>1;e[s]=t}return e}const w=g();function U(t,e,s,i){let r=w,n=i+s;t^=-1;for(let a=i;a<n;a++)t=t>>>8^r[(t^e[a])&255];return t^-1}const d=new TextEncoder;var y=class p{#t=[];#e=[];#s=0;constructor(){}static generateCentralDirectoryHeader(e,s){let i=new ArrayBuffer(46+e.filename.length),r=new Uint8Array(i),n=new DataView(i);n.setUint32(0,1347092738),n.setUint16(4,20,!0),n.setUint16(6,20,!0),n.setUint16(12,e.modifyTime,!0),n.setUint16(14,e.modifyDate,!0),n.setUint32(16,e.checksum,!0),n.setUint32(20,e.compressedSize,!0),n.setUint32(24,e.uncompressedSize,!0),n.setUint16(28,e.filename.length,!0),n.setUint32(42,s,!0);let a=d.encode(e.filename);return r.set(a,46),n.buffer}addFile(e){let s=p.generateCentralDirectoryHeader(e,this.#s);this.#t.push(e),this.#e.push(s),this.#s+=e.localFileHeader.byteLength,this.#s+=e.content.length}pack(){let e=this.#e.reduce((n,a)=>(n+=a.byteLength,n),0);this.#s+=e;let s=new ArrayBuffer(22),i=new DataView(s);i.setUint32(0,1347093766),i.setUint16(8,this.#t.length,!0),i.setUint16(10,this.#t.length,!0),i.setUint32(12,e,!0),i.setUint32(16,this.#s-e,!0);let r=[];for(let n of this.#t)r.push(n.localFileHeader),r.push(n.content);return r.push(...this.#e),r.push(i.buffer),new Blob(r)}},b=class{modifyTime;modifyDate;checksum;compressedSize;uncompressedSize;filename;content;constructor(t,e){this.filename=t,this.content=e;let{date:s,time:i}=v();this.modifyTime=i,this.modifyDate=s,this.checksum=U(0,e,e.length,0),this.compressedSize=e.length,this.uncompressedSize=e.length}get localFileHeader(){let t=new ArrayBuffer(30+this.filename.length),e=new Uint8Array(t),s=new DataView(t);s.setUint32(0,1347093252),s.setUint16(4,20,!0),s.setUint16(10,this.modifyTime,!0),s.setUint16(12,this.modifyDate,!0),s.setUint32(14,this.checksum,!0),s.setUint32(18,this.compressedSize,!0),s.setUint32(22,this.uncompressedSize,!0),s.setUint16(26,this.filename.length,!0);let i=d.encode(this.filename);return e.set(i,30),s.buffer}};function v(){let t=new Date,e=t.getUTCHours();e<<=6,e|=t.getUTCMinutes(),e<<=5,e|=t.getUTCSeconds()/2;let s=t.getUTCFullYear()-1980;return s<<=4,s|=t.getUTCMonth()+1,s<<=5,s|=t.getUTCDate(),{date:s,time:e}}const m={"image/png":"png","image/jpeg":"jpg","image/webp":"webp"};var h=class extends EventTarget{#t=0;#e;#s=[];#i;#n;#o;#c;#r=0;#a;state="inactive";constructor(t,e,s=60){super(),this.#e=t,this.#n=1e3/s,this.#a=e}start(){this.state="recording",this.dispatchEvent(new CustomEvent("start")),this.frame()}stop(){this.state="inactive",this.#i&&cancelAnimationFrame(this.#i);let t=Promise.all(this.#s.map(s=>s.arrayBuffer())),e=new y;t.then(s=>{for(let i=0;i<s.length;i++){let r=new b(`capture-${String(i+1).padStart(5,"0")}.${m[this.#a]}`,new Uint8Array(s[i]));e.addFile(r)}this.dispatchEvent(new CustomEvent("stop",{detail:{blob:e.pack()}}))})}pause(){this.state="paused",this.#i&&cancelAnimationFrame(this.#i),this.dispatchEvent(new CustomEvent("pause"))}resume(){this.state="recording",this.dispatchEvent(new CustomEvent("resume")),this.frame()}frame(t){if(this.state==="recording"){if(this.#o=t-this.#c,this.#c=t,this.#r+=this.#o||0,this.#r>=this.#n||this.#n===1/0){this.#r=0;let e=this.#t;this.#e.toBlob(s=>{this.#s[e]=s},this.#a),this.#t++}this.#n<1/0&&(this.#i=requestAnimationFrame(this.frame.bind(this)))}}},l=class{#t;#e;constructor(t){let e=t.frameRate==="manual"?0:t.frameRate,s=[],i=t.source instanceof HTMLCanvasElement?t.source:t.source.canvas,r=i.captureStream(e),n;n=Object.keys(m).includes(t.mimeType)?new h(i,t.mimeType,e):new MediaRecorder(r,{mimeType:t.mimeType??"video/webm;codecs=vp8"}),n.addEventListener("start",()=>{console.log("recording started")}),n.addEventListener("stop",a=>{let o,c;if(this.#e instanceof h?(o=a.detail.blob,c="recording.zip"):(o=new Blob(s),c="recording.webm"),typeof t?.stopCallback!="function"||t?.stopCallback(o)){let f=URL.createObjectURL(o),u=document.createElement("a");u.href=f,u.download=c,u.click()}}),n.addEventListener("dataavailable",a=>{s.push(a.data)}),n.addEventListener("pause",()=>{console.log("recording paused")}),n.addEventListener("resume",()=>{console.log("recording resumed")}),this.#e=n,this.#t=r}get state(){return this.#e.state}start(){this.#e.start()}stop(){this.#e.stop()}pause(){this.#e.pause()}resume(){this.#e.resume()}frame(){this.#e instanceof h?this.#e.frame():this.#t.getVideoTracks()[0].requestFrame()}};function T(t,e,s){let i,r,n=t.VERSION.split(".").map(a=>parseInt(a));if(!(n[0]>2||n[0]===2&&n[1]>0||n[0]===2&&n[1]===0&&n[2]>=3)){console.error("p5.record.js requires p5.js >= 2.0.3");return}t.Recorder=l,s.postdraw=function(){i&&i.state==="recording"&&r?.frameRate==="manual"&&i.frame()},e.setRecording=function(a){if(a.frameRate==="manual"&&!("CanvasCaptureMediaStreamTrack"in window)&&!Object.keys(m).includes(a.mimeType)){console.error("Your browser does not support directly specifying frame capture timing with { frameRate: 'manual' }.");return}r=a},e.startRecording=function(){r=Object.assign({source:this.canvas,frameRate:this.getTargetFrameRate(),stopCallback:this._customActions?.recordingStopped},r),i=new l(r),i.start()},e.stopRecording=function(){i.stop()},e.pauseRecording=function(){i.pause()},e.resumeRecording=function(){i.resume()},e.createRecording=function(a){return new l(a)}}typeof p5<"u"&&p5.registerAddon(T);export{l as Recorder,T as p5Record};
